import re
import os
from django.conf import settings
from .models import ChatbotKnowledge, HealthSymptom

try:
    from openai import OpenAI
except ImportError:
    OpenAI = None

class ChatbotService:
    def __init__(self):
        self.openai_client = None
        if OpenAI and hasattr(settings, 'OPENAI_API_KEY') and settings.OPENAI_API_KEY:
            self.openai_client = OpenAI(api_key=settings.OPENAI_API_KEY)

    def get_response(self, message, user=None):
        """
        Xá»­ lÃ½ tin nháº¯n tá»« ngÆ°á»i dÃ¹ng vÃ  tráº£ vá» pháº£n há»“i
        """
        message = message.lower().strip()
        
        # Kiá»ƒm tra cÃ¡c cÃ¢u há»i thÆ°á»ng gáº·p
        faq_response = self._check_faq(message)
        if faq_response:
            return faq_response
        
        # Kiá»ƒm tra triá»‡u chá»©ng
        symptom_response = self._check_symptoms(message)
        if symptom_response:
            return symptom_response
        
        # Sá»­ dá»¥ng OpenAI náº¿u cÃ³ API key
        if self.openai_client:
            try:
                return self._get_openai_response(message, user)
            except Exception as e:
                print(f"OpenAI Error: {e}")
        
        # Pháº£n há»“i máº·c Ä‘á»‹nh
        return self._get_default_response(message)

    def _check_faq(self, message):
        """
        Kiá»ƒm tra kiáº¿n thá»©c cÃ³ sáºµn trong database
        """
        try:
            knowledge_items = ChatbotKnowledge.objects.filter(is_active=True)
            
            for item in knowledge_items:
                keywords = [kw.strip() for kw in item.keywords.split(',')]
                if any(keyword.lower() in message for keyword in keywords):
                    return item.answer
                    
            return None
        except Exception:
            return None

    def _check_symptoms(self, message):
        """
        Kiá»ƒm tra triá»‡u chá»©ng vÃ  Ä‘Æ°a ra lá»i khuyÃªn
        """
        try:
            symptoms = HealthSymptom.objects.all()
            
            for symptom in symptoms:
                if symptom.name.lower() in message:
                    response = f"Vá» triá»‡u chá»©ng '{symptom.name}':\n\n"
                    response += f"{symptom.description}\n\n"
                    response += f"Lá»i khuyÃªn: {symptom.advice}\n\n"
                    
                    if symptom.severity_level >= 4:
                        response += "âš ï¸ ÄÃ¢y lÃ  triá»‡u chá»©ng nghiÃªm trá»ng. Báº¡n nÃªn Ä‘i khÃ¡m bÃ¡c sÄ© ngay láº­p tá»©c."
                    elif symptom.severity_level >= 3:
                        response += "âš ï¸ Báº¡n nÃªn theo dÃµi triá»‡u chá»©ng vÃ  Ä‘i khÃ¡m bÃ¡c sÄ© náº¿u tÃ¬nh tráº¡ng khÃ´ng cáº£i thiá»‡n."
                    else:
                        response += "ğŸ’¡ Triá»‡u chá»©ng nÃ y thÆ°á»ng khÃ´ng nghiÃªm trá»ng, nhÆ°ng hÃ£y theo dÃµi sá»± thay Ä‘á»•i."
                    
                    return response
                    
            return None
        except Exception:
            return None

    def _get_openai_response(self, message, user=None):
        """
        Sá»­ dá»¥ng OpenAI Ä‘á»ƒ táº¡o pháº£n há»“i
        """
        system_prompt = """
        Báº¡n lÃ  má»™t trá»£ lÃ½ AI chÄƒm sÃ³c sá»©c khá»e tÃªn HealthyBot. 
        HÃ£y tráº£ lá»i báº±ng tiáº¿ng Viá»‡t má»™t cÃ¡ch thÃ¢n thiá»‡n vÃ  há»¯u Ã­ch.
        LuÃ´n nháº¯c nhá»Ÿ ngÆ°á»i dÃ¹ng ráº±ng báº¡n chá»‰ cung cáº¥p thÃ´ng tin tham kháº£o 
        vÃ  há» nÃªn tham kháº£o Ã½ kiáº¿n bÃ¡c sÄ© cho cÃ¡c váº¥n Ä‘á» sá»©c khá»e nghiÃªm trá»ng.
        KhÃ´ng Ä‘Æ°a ra cháº©n Ä‘oÃ¡n y táº¿ cá»¥ thá»ƒ.
        """
        
        try:
            # ThÃªm thÃ´ng tin ngÆ°á»i dÃ¹ng náº¿u cÃ³
            user_context = ""
            if user and hasattr(user, 'patient'):
                try:
                    patient = user.patient
                    user_context = f"""
                    ThÃ´ng tin ngÆ°á»i dÃ¹ng:
                    - Há» tÃªn: {user.get_full_name()}
                    - Giá»›i tÃ­nh: {patient.get_gender_display()}
                    - Tuá»•i: {patient.age}
                    - NhÃ³m mÃ¡u: {patient.blood_group if patient.blood_group else "KhÃ´ng cÃ³ thÃ´ng tin"}
                    - CÃ¡c bá»‡nh mÃ£n tÃ­nh: {patient.chronic_diseases if patient.chronic_diseases else "KhÃ´ng cÃ³ thÃ´ng tin"}
                    - Dá»‹ á»©ng: {patient.allergies if patient.allergies else "KhÃ´ng cÃ³ thÃ´ng tin"}
                    """
                except:
                    pass
            
            response = self.openai_client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=[
                    {"role": "system", "content": system_prompt + user_context},
                    {"role": "user", "content": message}
                ],
                max_tokens=500,
                temperature=0.7
            )
            
            return response.choices[0].message.content
        except Exception as e:
            print(f"OpenAI API Error: {e}")
            return self._get_default_response(message)

    def _get_default_response(self, message):
        """
        Pháº£n há»“i máº·c Ä‘á»‹nh khi khÃ´ng thá»ƒ xá»­ lÃ½ tin nháº¯n
        """
        greetings = ['xin chÃ o', 'hello', 'hi', 'chÃ o', 'chÃ o báº¡n']
        thanks = ['cáº£m Æ¡n', 'thanks', 'thank you', 'cÃ¡m Æ¡n']
        health_keywords = ['Ä‘au', 'bá»‡nh', 'khá»e', 'sá»©c khá»e', 'triá»‡u chá»©ng', 'thuá»‘c']
        appointment_keywords = ['Ä‘áº·t lá»‹ch', 'háº¹n', 'khÃ¡m', 'bÃ¡c sÄ©']
        
        if any(greeting in message for greeting in greetings):
            return """
            Xin chÃ o! TÃ´i lÃ  HealthyBot, trá»£ lÃ½ AI chÄƒm sÃ³c sá»©c khá»e cá»§a báº¡n. ğŸ¥
            
            TÃ´i cÃ³ thá»ƒ giÃºp báº¡n:
            â€¢ TÆ° váº¥n vá» cÃ¡c triá»‡u chá»©ng sá»©c khá»e cÆ¡ báº£n
            â€¢ ThÃ´ng tin vá» viá»‡c Ä‘áº·t lá»‹ch khÃ¡m
            â€¢ Lá»i khuyÃªn vá» lá»‘i sá»‘ng lÃ nh máº¡nh
            â€¢ Tráº£ lá»i cÃ¡c cÃ¢u há»i y táº¿ thÆ°á»ng gáº·p
            
            Báº¡n cÃ³ thá»ƒ há»i tÃ´i báº¥t cá»© Ä‘iá»u gÃ¬ vá» sá»©c khá»e! ğŸ˜Š
            """
        
        elif any(thank in message for thank in thanks):
            return "Ráº¥t vui Ä‘Æ°á»£c giÃºp Ä‘á»¡ báº¡n! Náº¿u cÃ³ thÃªm cÃ¢u há»i nÃ o khÃ¡c vá» sá»©c khá»e, Ä‘á»«ng ngáº§n ngáº¡i há»i tÃ´i nhÃ©! ğŸ˜Š"
        
        elif any(keyword in message for keyword in health_keywords):
            return """
            TÃ´i hiá»ƒu báº¡n Ä‘ang quan tÃ¢m Ä‘áº¿n váº¥n Ä‘á» sá»©c khá»e. 
            
            HÃ£y mÃ´ táº£ chi tiáº¿t hÆ¡n vá»:
            â€¢ Triá»‡u chá»©ng báº¡n Ä‘ang gáº·p pháº£i
            â€¢ Thá»i gian xuáº¥t hiá»‡n triá»‡u chá»©ng
            â€¢ Má»©c Ä‘á»™ nghiÃªm trá»ng
            
            TÃ´i sáº½ cá»‘ gáº¯ng Ä‘Æ°a ra lá»i khuyÃªn phÃ¹ há»£p. Tuy nhiÃªn, hÃ£y nhá»› ráº±ng Ä‘Ã¢y chá»‰ lÃ  thÃ´ng tin tham kháº£o vÃ  báº¡n nÃªn tham kháº£o Ã½ kiáº¿n bÃ¡c sÄ© chuyÃªn khoa khi cáº§n thiáº¿t.
            """
        
        elif any(keyword in message for keyword in appointment_keywords):
            return """
            Äá»ƒ Ä‘áº·t lá»‹ch khÃ¡m, báº¡n cÃ³ thá»ƒ:
            
            1. ğŸ“± Sá»­ dá»¥ng tÃ­nh nÄƒng "Äáº·t lá»‹ch khÃ¡m" trÃªn website
            2. ğŸ“ Gá»i Ä‘iá»‡n thoáº¡i Ä‘áº¿n sá»‘ hotline: 1900-XXX-XXX
            3. ğŸ¥ Äáº¿n trá»±c tiáº¿p táº¡i bá»‡nh viá»‡n
            
            Báº¡n sáº½ cáº§n cung cáº¥p:
            â€¢ ThÃ´ng tin cÃ¡ nhÃ¢n
            â€¢ ChuyÃªn khoa muá»‘n khÃ¡m
            â€¢ Thá»i gian mong muá»‘n
            â€¢ LÃ½ do khÃ¡m bá»‡nh
            
            Báº¡n cÃ³ muá»‘n tÃ´i hÆ°á»›ng dáº«n chi tiáº¿t hÆ¡n khÃ´ng?
            """
        
        else:
            return """
            Xin lá»—i, tÃ´i chÆ°a hiá»ƒu rÃµ cÃ¢u há»i cá»§a báº¡n. 
            
            TÃ´i cÃ³ thá»ƒ giÃºp báº¡n vá»:
            â€¢ TÆ° váº¥n sá»©c khá»e vÃ  triá»‡u chá»©ng
            â€¢ HÆ°á»›ng dáº«n Ä‘áº·t lá»‹ch khÃ¡m
            â€¢ ThÃ´ng tin vá» bÃ¡c sÄ© vÃ  chuyÃªn khoa
            â€¢ Lá»i khuyÃªn vá» lá»‘i sá»‘ng lÃ nh máº¡nh
            
            Báº¡n cÃ³ thá»ƒ há»i cá»¥ thá»ƒ hÆ¡n khÃ´ng? ğŸ˜Š
            """
